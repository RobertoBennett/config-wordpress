# =============================================
# 1. НАСТРОЙКИ MIME-ТИПОВ
# =============================================

<IfModule mod_mime.c>
    AddType application/vnd.ms-fontobject .eot
    AddType application/x-font-opentype .otf
    AddType image/svg+xml .svg
    AddType application/x-font-ttf .ttf
    AddType application/font-woff .woff
    AddType application/font-woff2 .woff2
    AddType application/javascript .jsonp
    AddType x-font/woff .woff
    AddType x-font/ttf .ttf
</IfModule>

# =============================================
# 2. КЭШИРОВАНИЕ И СЖАТИЕ
# =============================================

# Настройки кэширования браузера
<IfModule mod_expires.c>
    ExpiresActive on
    ExpiresDefault 'access plus 1 month'
    
    # Динамический контент
    ExpiresByType text/cache-manifest 'access plus 0 seconds'
    ExpiresByType text/html 'access plus 0 seconds'
    ExpiresByType text/xml 'access plus 0 seconds'
    ExpiresByType application/xml 'access plus 0 seconds'
    ExpiresByType application/json 'access plus 0 seconds'
    ExpiresByType text/txt "access plus 1 hour"
    
    # RSS и Atom фиды
    ExpiresByType application/rss+xml 'access plus 1 hour'
    ExpiresByType application/atom+xml 'access plus 1 hour'
    
    # Изображения
    ExpiresByType image/x-icon 'access plus 1 week'
    ExpiresByType image/gif 'access plus 4 months'
    ExpiresByType image/png 'access plus 4 months'
    ExpiresByType image/jpeg 'access plus 4 months'
    ExpiresByType image/webp 'access plus 4 months'
    ExpiresByType image/svg+xml 'access plus 1 month'
    
    # Видео и аудио
    ExpiresByType video/ogg 'access plus 4 months'
    ExpiresByType audio/ogg 'access plus 4 months'
    ExpiresByType video/mp4 'access plus 4 months'
    ExpiresByType video/webm 'access plus 4 months'
    
    # Шрифты
    ExpiresByType font/ttf 'access plus 4 months'
    ExpiresByType font/otf 'access plus 4 months'
    ExpiresByType font/woff 'access plus 4 months'
    ExpiresByType font/woff2 'access plus 4 months'
    ExpiresByType application/vnd.ms-fontobject 'access plus 1 month'
    ExpiresByType text/x-component 'access plus 1 month'
    
    # CSS и JavaScript
    ExpiresByType text/css 'access plus 1 year'
    ExpiresByType application/javascript 'access plus 1 year'
</IfModule>

# Настройки сжатия GZIP
<IfModule mod_deflate.c>
    # Текстовые файлы
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE text/txt
    
    # XML и JSON
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    
    # Шрифты
    AddOutputFilterByType DEFLATE application/x-font-ttf
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
    AddOutputFilterByType DEFLATE font/opentype font/ttf font/eot font/otf
    
    # Изображения SVG
    AddOutputFilterByType DEFLATE image/svg+xml
</IfModule>

# =============================================
# 3. ЗАГОЛОВКИ БЕЗОПАСНОСТИ
# =============================================

<IfModule mod_headers.c>
    # Основные заголовки безопасности
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Content-Security-Policy "upgrade-insecure-requests"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Удаление информации о сервере
    Header unset X-Powered-By
    Header unset ETag
    FileETag None
    
    # CORS и кэширование
    Header set Access-Control-Max-Age "86400" env=CORS
    Header append Vary "Accept-Encoding"
    
    # Настройки для HTML и PHP файлов
    <FilesMatch "\.(php|html)$">
        # Безопасность cookies
        Header always edit Set-Cookie ^(.*)$ "$1; SameSite=None; Secure=true"
        
        # Дополнительные заголовки безопасности
        Header set X-Download-Options "noopen"
        Header set X-Permitted-Cross-Domain-Policies "none"
        Header set X-DNS-Prefetch-Control "on"
        Header set X-UA-Compatible "IE=edge,chrome=1"
        
        # HSTS (только для HTTPS)
        Header set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" env=HTTPS
        
        # Cross-Origin политики
        Header set Cross-Origin-Resource-Policy "cross-origin"
        Header set Cross-Origin-Embedder-Policy "unsafe-none"
        Header set Cross-Origin-Opener-Policy "same-origin-allow-popups"
        
        # Языковые настройки
        Header set Accept-Language "ru-RU"
        Header set Accept-Charset "utf-8"
        Header set Content-Language "ru"
        
        # Кэширование и соединение
        Header set Connection keep-alive
        Header set Age "60"
        Header set Cache-Control "no-transform, public, proxy-revalidate, max-age=300, s-maxage=900"
        
        # Permissions Policy
        Header always set Permissions-Policy "accelerometer=(),autoplay=(),camera=(),encrypted-media=(),fullscreen=*,geolocation=*,gyroscope=(),magnetometer=(),microphone=(),midi=(),payment=(),sync-xhr=*,usb=(),xr-spatial-tracking=()"
        
        # Network Error Logging
        Header set NEL '{"report_to": "default", "max_age": 3600, "include_subdomains": true, "failure_fraction": 0.1}'
    </FilesMatch>
</IfModule>

# =============================================
# 4. ИСКЛЮЧЕНИЯ
# =============================================

# Start Exclude
RewriteCond %{REQUEST_URI} !^/wp-admin/profile.php [NC]
RewriteCond %{REQUEST_URI} !^/wp-login.php [NC]
# End Exclude

# Start_Exclude_Admin_Cookie - ИСПРАВЛЕНО
RewriteCond %{HTTP:Cookie} !wordpress_logged_in_[^\=]+\=[^;]+ [NC]
# End_Exclude_Admin_Cookie

# =============================================
# 5. WORDPRESS REWRITE RULES И КЭШИРОВАНИЕ
# =============================================

# Основные правила перезаписи WordPress
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
    RewriteBase /
    RewriteRule ^index\.php$ - [L]
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule . /index.php [L]
</IfModule>

# Правила кэширования УЛУЧШЕННЫЕ
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /
    
    # Исключаем админ-панель и системные страницы из кэширования
    RewriteCond %{REQUEST_URI} !^/wp-admin/ [NC]
    RewriteCond %{REQUEST_URI} !^/wp-login\.php [NC]
    RewriteCond %{REQUEST_URI} !^/wp-cron\.php [NC]
    RewriteCond %{REQUEST_URI} !^/xmlrpc\.php [NC]
    RewriteCond %{REQUEST_URI} !^/wp-json/ [NC]
    
    # Основные условия для кэширования
    RewriteCond %{HTTPS} =on
    RewriteCond %{HTTP_HOST} ^site\.ru$ [NC]
    RewriteCond %{HTTP_USER_AGENT} !(facebookexternalhit|Twitterbot|LinkedInBot|WhatsApp|Mediatoolkitbot|WP\sFastest\sCache\sPreload(\siPhone\sMobile)?\s*Bot) [NC]
    RewriteCond %{REQUEST_METHOD} !POST
    RewriteCond %{REQUEST_URI} !(\/){2}$
    RewriteCond %{REQUEST_URI} \/$
    RewriteCond %{QUERY_STRING} !.+
    
    # ИСПРАВЛЕННОЕ условие для куки - исключаем ВСЕХ авторизованных пользователей
    RewriteCond %{HTTP:Cookie} !(comment_author_|safirmobilswitcher=mobil|wordpress_logged_in_[^\=]+\=[^;]+) [NC]
    RewriteCond %{HTTP:Profile} !^[a-z0-9\"]+ [NC]
    
    # Дополнительные исключения для авторизованных пользователей
    RewriteCond %{HTTP:Cookie} !wp-settings-time [NC]
    RewriteCond %{HTTP:Cookie} !wordpress_test_cookie [NC]
    
    # Проверка существования кэш-файла
    RewriteCond %{DOCUMENT_ROOT}/wp-content/cache/all/$1/index.html -f [OR]
    RewriteCond /home/user/web/site.ru/public_html/wp-content/cache/all/$1/index.html -f
    
    RewriteRule ^(.*) "/wp-content/cache/all/$1/index.html" [L]
</IfModule>

# Дополнительные заголовки для правильного кэширования
<IfModule mod_headers.c>
    # Для авторизованных пользователей - отключаем кэширование
    Header always set Cache-Control "no-cache, no-store, must-revalidate" env=wordpress_logged_in
    Header always set Pragma "no-cache" env=wordpress_logged_in
    Header always set Expires "0" env=wordpress_logged_in
    
    # Устанавливаем переменную окружения для авторизованных пользователей
    SetEnvIf Cookie "wordpress_logged_in_[^=]+=[^;]+" wordpress_logged_in
</IfModule>

# Исключения для определенных страниц (если нужно)
<IfModule mod_rewrite.c>
    # Исключаем страницы профиля и личного кабинета
    RewriteCond %{REQUEST_URI} ^/profile/ [NC,OR]
    RewriteCond %{REQUEST_URI} ^/account/ [NC,OR]
    RewriteCond %{REQUEST_URI} ^/dashboard/ [NC]
    RewriteRule .* - [E=no-cache:1]
</IfModule>

# =============================================
# КОНЕЦ КОНФИГУРАЦИИ
# =============================================
